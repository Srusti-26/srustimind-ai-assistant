<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SRUSTI AI Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .chat-container { height: 70vh; overflow-y: auto; padding: 20px; background-color: white; border-radius: 10px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);}
        .message { margin-bottom: 15px; padding: 10px 15px; border-radius: 10px; max-width: 80%; }
        .user-message { background-color: #007bff; color: white; margin-left: auto; }
        .assistant-message { background-color: #e9ecef; color: #212529; }
        .loading-spinner { display: inline-block; width: 2rem; height: 2rem; vertical-align: text-bottom; border: 0.25em solid currentColor; border-right-color: transparent; border-radius: 50%; animation: spinner-border .75s linear infinite; }
        .feedback-stars { color: #ffc107; cursor: pointer; font-size: 1.5rem; }
        .tab-content { padding: 20px 0; }
        .model-loading { text-align: center; padding: 50px 0; }
        pre { background-color: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
        code { font-family: 'Courier New', Courier, monospace; }
        .nav-tabs .nav-link { font-weight: 500; }
        .nav-tabs .nav-link.active { font-weight: 600; color: #007bff; }
        /* --- Add this to force-disable strikethrough --- */
        del, s, strike {
            text-decoration: none !important;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center mb-4">
                    <i class="fas fa-robot text-primary me-2"></i>
                    SRUSTI AI Assistant
                </h1>
            </div>
        </div>
        <!-- Model Loading Status -->
        <div id="modelLoading" class="model-loading">
            <h3>Loading AI Model...</h3>
            <div class="progress mt-3 mb-3" style="height: 25px;">
                <div id="modelLoadingProgress" class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
            </div>
            <p id="modelLoadingMessage">Initializing...</p>
        </div>
        <!-- Main Interface (hidden until model loads) -->
        <div id="mainInterface" class="row" style="display: none;">
            <div class="col-12">
                <ul class="nav nav-tabs" id="myTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="chat-tab" data-bs-toggle="tab" data-bs-target="#chat" 
                                type="button" role="tab" aria-controls="chat" aria-selected="true">
                            <i class="fas fa-comment-dots me-2"></i>Chat
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="summarize-tab" data-bs-toggle="tab" data-bs-target="#summarize" 
                                type="button" role="tab" aria-controls="summarize" aria-selected="false">
                            <i class="fas fa-file-alt me-2"></i>Summarize
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="creative-tab" data-bs-toggle="tab" data-bs-target="#creative" 
                                type="button" role="tab" aria-controls="creative" aria-selected="false">
                            <i class="fas fa-paint-brush me-2"></i>Creative
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" 
                                type="button" role="tab" aria-controls="history" aria-selected="false">
                            <i class="fas fa-history me-2"></i>History
                        </button>
                    </li>
                </ul>
                <div class="tab-content" id="myTabContent">
                    <!-- Chat Tab -->
                    <div class="tab-pane fade show active" id="chat" role="tabpanel" aria-labelledby="chat-tab">
                        <div class="chat-container mb-3" id="chatMessages">
                            <div class="text-center text-muted py-5">
                                <i class="fas fa-comment-dots fa-3x mb-3"></i>
                                <p>Ask me anything! I'm here to help.</p>
                            </div>
                        </div>
                        <div class="input-group mb-3">
                            <input type="text" id="questionInput" class="form-control" 
                                   placeholder="Type your question here..." aria-label="Question">
                            <button class="btn btn-primary" type="button" id="sendQuestionBtn">
                                <i class="fas fa-paper-plane"></i> Send
                            </button>
                        </div>
                    </div>
                    <!-- Summarize Tab -->
                    <div class="tab-pane fade" id="summarize" role="tabpanel" aria-labelledby="summarize-tab">
                        <div class="mb-3">
                            <label for="textToSummarize" class="form-label">Enter text to summarize:</label>
                            <textarea class="form-control" id="textToSummarize" rows="10" 
                                      placeholder="Paste your text here..."></textarea>
                        </div>
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" type="button" id="summarizeBtn">
                                <i class="fas fa-compress-alt"></i> Summarize
                            </button>
                        </div>
                        <div class="mt-4" id="summaryResult" style="display: none;">
                            <h4>Summary:</h4>
                            <div class="card">
                                <div class="card-body" id="summaryText"></div>
                            </div>
                            <div class="mt-3 text-center" id="summaryFeedback"></div>
                        </div>
                    </div>
                    <!-- Creative Tab -->
                    <div class="tab-pane fade" id="creative" role="tabpanel" aria-labelledby="creative-tab">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="contentType" class="form-label">Content Type:</label>
                                <select class="form-select" id="contentType">
                                    <option value="story">Story</option>
                                    <option value="poem">Poem</option>
                                    <option value="essay">Essay</option>
                                    <option value="dialogue">Dialogue</option>
                                    <option value="song">Song Lyrics</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="contentTopic" class="form-label">Topic or Theme:</label>
                                <input type="text" class="form-control" id="contentTopic" 
                                       placeholder="Enter a topic or theme...">
                            </div>
                        </div>
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" type="button" id="generateCreativeBtn">
                                <i class="fas fa-magic"></i> Generate Creative Content
                            </button>
                        </div>
                        <div class="mt-4" id="creativeResult" style="display: none;">
                            <h4 id="creativeTitle">Your Creative Content:</h4>
                            <div class="card">
                                <div class="card-body" id="creativeText"></div>
                            </div>
                            <div class="mt-3 text-center" id="creativeFeedback"></div>
                        </div>
                    </div>
                    <!-- History Tab -->
                    <div class="tab-pane fade" id="history" role="tabpanel" aria-labelledby="history-tab">
                        <div class="d-flex justify-content-end mb-3">
                            <button class="btn btn-outline-secondary me-2" id="downloadHistoryBtn">
                                <i class="fas fa-download"></i> Download History
                            </button>
                            <button class="btn btn-outline-danger" id="clearHistoryBtn">
                                <i class="fas fa-trash"></i> Clear History
                            </button>
                        </div>
                        <div id="historyContainer">
                            <div class="text-center text-muted py-5" id="emptyHistory">
                                <i class="fas fa-history fa-3x mb-3"></i>
                                <p>No conversation history yet.</p>
                            </div>
                            <div id="historyList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        // Disable strikethrough in marked
        marked.use({
            renderer: {
                del(text) { return text; } // just return the text, no <del> tag
            }
        });

        // Helper to remove all strikethrough tags and markdown
        function sanitizeResponse(text) {
            return text
                .replace(/~~/g, "")
                .replace(/<\/?del>/g, "")
                .replace(/<\/?s>/g, "")
                .replace(/<\/?strike>/g, "");
        }

        document.addEventListener('DOMContentLoaded', function() {
            checkModelStatus();
            document.getElementById('sendQuestionBtn').addEventListener('click', sendQuestion);
            document.getElementById('questionInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') sendQuestion();
            });
            document.getElementById('summarizeBtn').addEventListener('click', summarizeText);
            document.getElementById('generateCreativeBtn').addEventListener('click', generateCreative);
            document.getElementById('clearHistoryBtn').addEventListener('click', clearHistory);
            document.getElementById('downloadHistoryBtn').addEventListener('click', downloadHistory);
            document.getElementById('history-tab').addEventListener('shown.bs.tab', loadHistory);
        });

        function checkModelStatus() {
            fetch('/model_status')
            .then(response => response.json())
            .then(data => {
                const progressBar = document.getElementById('modelLoadingProgress');
                const message = document.getElementById('modelLoadingMessage');
                progressBar.style.width = data.progress + '%';
                progressBar.textContent = data.progress + '%';
                message.textContent = data.message;
                if (data.status === "complete") {
                    document.getElementById('modelLoading').style.display = 'none';
                    document.getElementById('mainInterface').style.display = 'block';
                } else if (data.status === "error") {
                    message.textContent = "Error loading model: " + data.message;
                    progressBar.classList.add('bg-danger');
                } else {
                    setTimeout(checkModelStatus, 1000);
                }
            })
            .catch(error => {
                console.error('Error checking model status:', error);
                document.getElementById('modelLoadingMessage').textContent = 'Error checking model status. Please refresh.';
                document.getElementById('modelLoadingProgress').classList.add('bg-danger');
            });
        }

        function sendQuestion() {
            const questionInput = document.getElementById('questionInput');
            const question = questionInput.value.trim();
            if (!question) return;
            addMessageToChat('user', question);
            questionInput.value = '';
            const loadingId = addLoadingMessage();
            fetch('/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: question, function_type: 'question' })
            })
            .then(response => response.json())
            .then(data => {
                removeLoadingMessage(loadingId);
                if (data.success) {
                    const messageId = addMessageToChat('assistant', data.response);
                    addFeedbackToMessage(messageId, 'question', question, data.response);
                } else {
                    addMessageToChat('system', 'Error: ' + data.error);
                }
            })
            .catch(error => {
                removeLoadingMessage(loadingId);
                console.error('Error:', error);
                addMessageToChat('system', 'Error communicating with the server. Please try again.');
            });
        }

        function summarizeText() {
            const textInput = document.getElementById('textToSummarize');
            const text = textInput.value.trim();
            if (!text) {
                alert('Please enter some text to summarize.');
                return;
            }
            document.getElementById('summaryResult').style.display = 'none';
            const summarizeBtn = document.getElementById('summarizeBtn');
            const originalBtnText = summarizeBtn.innerHTML;
            summarizeBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Summarizing...';
            summarizeBtn.disabled = true;
            fetch('/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: text, function_type: 'summary' })
            })
            .then(response => response.json())
            .then(data => {
                summarizeBtn.innerHTML = originalBtnText;
                summarizeBtn.disabled = false;
                if (data.success) {
                    document.getElementById('summaryText').innerHTML = marked.parse(sanitizeResponse(data.response));
                    document.getElementById('summaryResult').style.display = 'block';
                    const feedbackContainer = document.getElementById('summaryFeedback');
                    feedbackContainer.innerHTML = createFeedbackHTML('summary', text, data.response);
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                summarizeBtn.innerHTML = originalBtnText;
                summarizeBtn.disabled = false;
                console.error('Error:', error);
                alert('Error communicating with the server. Please try again.');
            });
        }

        function generateCreative() {
            const contentType = document.getElementById('contentType').value;
            const topic = document.getElementById('contentTopic').value.trim();
            if (!topic) {
                alert('Please enter a topic or theme.');
                return;
            }
            document.getElementById('creativeResult').style.display = 'none';
            const generateBtn = document.getElementById('generateCreativeBtn');
            const originalBtnText = generateBtn.innerHTML;
            generateBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generating...';
            generateBtn.disabled = true;
            const prompt = `Create an original ${contentType} with the theme: ${topic}. Be imaginative and engaging.`;
            fetch('/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: prompt, function_type: 'creative' })
            })
            .then(response => response.json())
            .then(data => {
                generateBtn.innerHTML = originalBtnText;
                generateBtn.disabled = false;
                if (data.success) {
                    document.getElementById('creativeTitle').textContent = `Your ${contentType.charAt(0).toUpperCase() + contentType.slice(1)}:`;
                    document.getElementById('creativeText').innerHTML = marked.parse(sanitizeResponse(data.response));
                    document.getElementById('creativeResult').style.display = 'block';
                    const feedbackContainer = document.getElementById('creativeFeedback');
                    feedbackContainer.innerHTML = createFeedbackHTML('creative', prompt, data.response);
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                generateBtn.innerHTML = originalBtnText;
                generateBtn.disabled = false;
                console.error('Error:', error);
                alert('Error communicating with the server. Please try again.');
            });
        }

        function addMessageToChat(sender, message) {
            const chatContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            const messageId = 'msg-' + Date.now();
            messageDiv.id = messageId;
            if (sender === 'user') {
                messageDiv.className = 'message user-message';
                messageDiv.textContent = message;
            } else if (sender === 'assistant') {
                messageDiv.className = 'message assistant-message';
                messageDiv.innerHTML = marked.parse(sanitizeResponse(message));
            } else {
                messageDiv.className = 'message system-message text-danger';
                messageDiv.textContent = message;
            }
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return messageId;
        }

        function addLoadingMessage() {
            const chatContainer = document.getElementById('chatMessages');
            const loadingDiv = document.createElement('div');
            const loadingId = 'loading-' + Date.now();
            loadingDiv.id = loadingId;
            loadingDiv.className = 'message assistant-message';
            loadingDiv.innerHTML = '<div class="loading-spinner"></div> Thinking...';
            chatContainer.appendChild(loadingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return loadingId;
        }

        function removeLoadingMessage(loadingId) {
            const loadingDiv = document.getElementById(loadingId);
            if (loadingDiv) loadingDiv.remove();
        }

        function addFeedbackToMessage(messageId, functionType, prompt, response) {
            const messageDiv = document.getElementById(messageId);
            if (!messageDiv) return;
            const feedbackDiv = document.createElement('div');
            feedbackDiv.className = 'mt-2 text-center';
            feedbackDiv.innerHTML = createFeedbackHTML(functionType, prompt, response);
            messageDiv.appendChild(feedbackDiv);
        }

        function createFeedbackHTML(functionType, prompt, response) {
            const feedbackId = 'feedback-' + Date.now();
            return `
                <div class="feedback-container" id="${feedbackId}">
                    <p class="small text-muted mb-1">Was this response helpful?</p>
                    <div class="feedback-stars mb-2">
                        <i class="far fa-star" data-rating="1" onclick="submitFeedback('${feedbackId}', '${functionType}', '${encodeURIComponent(prompt)}', '${encodeURIComponent(response)}', 1)"></i>
                        <i class="far fa-star" data-rating="2" onclick="submitFeedback('${feedbackId}', '${functionType}', '${encodeURIComponent(prompt)}', '${encodeURIComponent(response)}', 2)"></i>
                        <i class="far fa-star" data-rating="3" onclick="submitFeedback('${feedbackId}', '${functionType}', '${encodeURIComponent(prompt)}', '${encodeURIComponent(response)}', 3)"></i>
                        <i class="far fa-star" data-rating="4" onclick="submitFeedback('${feedbackId}', '${functionType}', '${encodeURIComponent(prompt)}', '${encodeURIComponent(response)}', 4)"></i>
                        <i class="far fa-star" data-rating="5" onclick="submitFeedback('${feedbackId}', '${functionType}', '${encodeURIComponent(prompt)}', '${encodeURIComponent(response)}', 5)"></i>
                    </div>
                </div>
            `;
        }

        function submitFeedback(feedbackId, functionType, encodedPrompt, encodedResponse, rating) {
            const prompt = decodeURIComponent(encodedPrompt);
            const response = decodeURIComponent(encodedResponse);
            const feedbackContainer = document.getElementById(feedbackId);
            const stars = feedbackContainer.querySelectorAll('.feedback-stars i');
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.remove('far');
                    star.classList.add('fas');
                } else {
                    star.classList.remove('fas');
                    star.classList.add('far');
                }
            });
            const commentsDiv = document.createElement('div');
            commentsDiv.className = 'mt-2';
            commentsDiv.innerHTML = `
                <textarea class="form-control form-control-sm" id="${feedbackId}-comments" 
                          placeholder="Any additional comments? (optional)"></textarea>
                <button class="btn btn-sm btn-primary mt-2" onclick="sendFeedback('${feedbackId}', '${functionType}', '${encodedPrompt}', '${encodedResponse}', ${rating})">
                    Submit Feedback
                </button>
            `;
            feedbackContainer.appendChild(commentsDiv);
        }

        function sendFeedback(feedbackId, functionType, encodedPrompt, encodedResponse, rating) {
            const prompt = decodeURIComponent(encodedPrompt);
            const response = decodeURIComponent(encodedResponse);
            const comments = document.getElementById(`${feedbackId}-comments`).value;
            const feedbackContainer = document.getElementById(feedbackId);
            fetch('/feedback', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    function_type: functionType,
                    prompt: prompt,
                    response: response,
                    rating: rating,
                    comments: comments
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    feedbackContainer.innerHTML = `
                        <div class="alert alert-success py-2">
                            <i class="fas fa-check-circle"></i> Thank you for your feedback!
                        </div>
                    `;
                } else {
                    feedbackContainer.innerHTML = `
                        <div class="alert alert-danger py-2">
                            <i class="fas fa-exclamation-circle"></i> Error saving feedback. Please try again.
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                feedbackContainer.innerHTML = `
                    <div class="alert alert-danger py-2">
                        <i class="fas fa-exclamation-circle"></i> Error saving feedback. Please try again.
                    </div>
                `;
            });
        }

        function loadHistory() {
            fetch('/history')
                .then(response => response.json())
                .then(data => {
                    const historyContainer = document.getElementById('historyList');
                    const emptyHistory = document.getElementById('emptyHistory');
                    if (data.success && data.history && data.history.length > 0) {
                        emptyHistory.style.display = 'none';
                        historyContainer.innerHTML = '';
                        data.history.forEach((item, index) => {
                            const historyItem = document.createElement('div');
                            historyItem.className = 'card mb-3';
                            historyItem.innerHTML = `
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span>
                                        <i class="fas ${getFunctionTypeIcon(item.type)} me-2"></i>
                                        ${formatFunctionType(item.type)}
                                    </span>
                                    <small class="text-muted">${item.timestamp}</small>
                                </div>
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-2 text-muted">Prompt:</h6>
                                    <p class="card-text">${item.prompt}</p>
                                    <h6 class="card-subtitle mb-2 text-muted">Response:</h6>
                                    <div class="card-text">${marked.parse(sanitizeResponse(item.response))}</div>
                                </div>
                            `;
                            historyContainer.appendChild(historyItem);
                        });
                    } else {
                        emptyHistory.style.display = 'block';
                        historyContainer.innerHTML = '';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('historyList').innerHTML = `
                        <div class="alert alert-danger">
                            Error loading history. Please try again.
                        </div>
                    `;
                });
        }

        function clearHistory() {
            if (!confirm('Are you sure you want to clear your conversation history?')) return;
            fetch('/clear_history', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadHistory();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error clearing history. Please try again.');
            });
        }

        function downloadHistory() {
            window.location.href = '/download_history';
        }

        function getFunctionTypeIcon(type) {
            switch(type) {
                case 'question': return 'fa-question-circle';
                case 'summary': return 'fa-file-alt';
                case 'creative': return 'fa-paint-brush';
                default: return 'fa-comment';
            }
        }

        function formatFunctionType(type) {
            switch(type) {
                case 'question': return 'Question & Answer';
                case 'summary': return 'Text Summary';
                case 'creative': return 'Creative Content';
                default: return type.charAt(0).toUpperCase() + type.slice(1);
            }
        }
    </script>
</body>
</html>